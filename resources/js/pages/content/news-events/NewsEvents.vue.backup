<script setup lang="ts">
import AppLayout from '@/layouts/AppLayout.vue';
import { Head, router } from '@inertiajs/vue3';
import { ref, reactive, computed } from 'vue';
import { type BreadcrumbItem } from '@/types';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Select } from '@/components/ui/select';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Textarea } from '@/components/ui/textarea';
import ConfirmDialog from '@/components/ui/ConfirmDialog.vue';
import { toast } from '@/components/ui/toast';
import RichTextEditor from '@/components/ui/RichTextEditor.vue';
import { Plus, Edit, Trash2, Calendar, FileText, Eye, EyeOff, Star, Search } from 'lucide-vue-next';

interface NewsEvent {
    id: number;
    type: string;
    category: string;
    title_id: string;
    title_en?: string;
    excerpt_id: string;
    author: string;
    is_published: boolean;
    is_featured: boolean;
    status: string;
    published_at?: string;
    start_date?: string;
    end_date?: string;
    location_id?: string;
    organizer?: string;
    view_count: number;
    created_at: string;
}

interface Props {
    newsEvents: {
        data: NewsEvent[];
        links: any[];
        meta: any;
    };
    categories: {
        news: Record<string, string>;
        event: Record<string, string>;
    };
    types: Record<string, string>;
    statuses: Record<string, string>;
    filters: {
        search?: string;
        type?: string;
        category?: string;
        status?: string;
    };
}

const props = defineProps<Props>();

const breadcrumbs: BreadcrumbItem[] = [
    { title: 'System Management', href: '/system' },
    { title: 'News & Events', href: '/system/news-events' },
];

const dialogOpen = ref(false);
const editingItem = ref<NewsEvent | null>(null);
const confirmDialog = ref({
    open: false,
    itemId: 0,
    loading: false
});

const form = reactive({
    type: 'news',
    category: '',
    title_id: '',
    title_en: '',
    excerpt_id: '',
    excerpt_en: '',
    content_id: '',
    content_en: '',
    author: '',
    location_id: '',
    location_en: '',
    start_date: '',
    end_date: '',
    organizer: '',
    price: null,
    max_participants: null,
    is_published: false,
    is_featured: false,
    status: 'draft',
    loading: false
});

const filters = reactive({
    search: props.filters.search || '',
    type: props.filters.type || '',
    category: props.filters.category || '',
    status: props.filters.status || '',
});

const currentCategories = computed(() => {
    return props.categories[form.type as keyof typeof props.categories] || {};
});

const isEvent = computed(() => form.type === 'event');

const openCreateDialog = () => {
    resetForm();
    editingItem.value = null;
    dialogOpen.value = true;
};

const openEditDialog = (item: NewsEvent) => {
    resetForm();
    editingItem.value = item;
    
    form.type = item.type;
    form.category = item.category;
    form.title_id = item.title_id;
    form.title_en = item.title_en || '';
    form.excerpt_id = item.excerpt_id;
    form.author = item.author;
    form.location_id = item.location_id || '';
    form.organizer = item.organizer || '';
    form.start_date = item.start_date ? item.start_date.substring(0, 16) : '';
    form.end_date = item.end_date ? item.end_date.substring(0, 16) : '';
    form.is_published = item.is_published;
    form.is_featured = item.is_featured;
    form.status = item.status;
    
    dialogOpen.value = true;
};

const resetForm = () => {
    form.type = 'news';
    form.category = '';
    form.title_id = '';
    form.title_en = '';
    form.excerpt_id = '';
    form.excerpt_en = '';
    form.content_id = '';
    form.content_en = '';
    form.author = '';
    form.location_id = '';
    form.location_en = '';
    form.start_date = '';
    form.end_date = '';
    form.organizer = '';
    form.price = null;
    form.max_participants = null;
    form.is_published = false;
    form.is_featured = false;
    form.status = 'draft';
    form.loading = false;
};

const getCsrfToken = () => {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
};

const handleSubmit = async () => {
    form.loading = true;
    
    try {
        const url = editingItem.value 
            ? `/api/system/news-events/${editingItem.value.id}`
            : '/api/system/news-events';
        
        const method = editingItem.value ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': getCsrfToken(),
            },
            credentials: 'include',
            body: JSON.stringify(form),
        });
        
        const data = await response.json();
        
        if (response.ok) {
            toast({
                title: 'Success',
                description: data.message,
                variant: 'success'
            });
            dialogOpen.value = false;
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            toast({
                title: 'Error',
                description: data.message || 'An error occurred',
                variant: 'error'
            });
        }
    } catch (error) {
        toast({
            title: 'Error',
            description: 'An error occurred while saving',
            variant: 'error'
        });
    } finally {
        form.loading = false;
    }
};

const confirmDelete = (id: number) => {
    confirmDialog.value = {
        open: true,
        itemId: id,
        loading: false
    };
};

const handleDelete = async () => {
    confirmDialog.value.loading = true;
    
    try {
        const response = await fetch(`/api/system/news-events/${confirmDialog.value.itemId}`, {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': getCsrfToken(),
            },
            credentials: 'include',
        });
        
        const data = await response.json();
        
        if (response.ok) {
            toast({
                title: 'Success',
                description: data.message,
                variant: 'success'
            });
            confirmDialog.value.open = false;
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            toast({
                title: 'Error',
                description: data.message || 'Failed to delete item',
                variant: 'error'
            });
        }
    } catch (error) {
        toast({
            title: 'Error',
            description: 'An error occurred while deleting',
            variant: 'error'
        });
    } finally {
        confirmDialog.value.loading = false;
    }
};

const getStatusBadgeVariant = (status: string) => {
    switch (status) {
        case 'published': return 'default';
        case 'draft': return 'secondary';
        case 'archived': return 'outline';
        case 'cancelled': return 'destructive';
        default: return 'secondary';
    }
};

const getTypeBadgeVariant = (type: string) => {
    switch (type) {
        case 'news': return 'default';
        case 'event': return 'secondary';
        case 'article': return 'outline';
        case 'announcement': return 'destructive';
        default: return 'secondary';
    }
};

const applyFilters = () => {
    const params = new URLSearchParams();
    
    if (filters.search) params.set('search', filters.search);
    if (filters.type) params.set('type', filters.type);
    if (filters.category) params.set('category', filters.category);
    if (filters.status) params.set('status', filters.status);
    
    const queryString = params.toString();
    const url = queryString ? `/system/news-events?${queryString}` : '/system/news-events';
    
    router.visit(url);
};

const clearFilters = () => {
    Object.assign(filters, { search: '', type: '', category: '', status: '' });
    router.visit('/system/news-events');
};
</script>

<template>
    <Head title="News & Events" />

    <AppLayout :breadcrumbs="breadcrumbs">
        <div class="flex h-full flex-1 flex-col gap-4 rounded-xl p-4">
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight">News & Events</h1>
                        <p class="text-muted-foreground">Manage news articles and events content</p>
                    </div>
                    
                    <Dialog v-model:open="dialogOpen">
                        <DialogTrigger as-child>
                            <Button @click="openCreateDialog">
                                <Plus class="w-4 h-4 mr-2" />
                                Create Content
                            </Button>
                        </DialogTrigger>
                        <DialogContent class="sm:max-w-[90vw] md:max-w-[80vw] lg:max-w-[70vw] max-h-[95vh] overflow-y-auto">
                            <DialogHeader>
                                <DialogTitle>
                                    {{ editingItem ? 'Edit' : 'Create' }} {{ types[form.type] }}
                                </DialogTitle>
                                <DialogDescription>
                                    {{ editingItem ? 'Update' : 'Create new' }} {{ form.type }} content
                                </DialogDescription>
                            </DialogHeader>

                            <form @submit.prevent="handleSubmit" class="space-y-6">
                                <!-- Type & Category -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <Label for="type">Type *</Label>
                                        <select v-model="form.type" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-background dark:text-foreground dark:border-input">
                                            <option value="">
                                                 Select type</option>
                                            
                                            
                                                <option v-for="(label, value) in types" :key="value" :value="value">
                                                    {{ label }}
                                                </SelectItem>
                                            </select>
                                        
                                    </div>
                                    <div class="space-y-2">
                                        <Label for="category">Category *</Label>
                                        <Select v-model="form.category" required>
                                            <option value="">
                                                <SelectValue placeholder="Select category" />
                                            
                                            
                                                <SelectItem v-for="(label, value) in currentCategories" :key="value" :value="value">
                                                    {{ label }}
                                                </SelectItem>
                                            </select>
                                        
                                    </div>
                                </div>

                                <!-- Titles -->
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-2">
                                        <Label for="title_id">Title (Indonesian) *</Label>
                                        <Input
                                            id="title_id"
                                            v-model="form.title_id"
                                            placeholder="Enter Indonesian title"
                                            required
                                        />
                                    </div>
                                    <div class="space-y-2">
                                        <Label for="title_en">Title (English)</Label>
                                        <Input
                                            id="title_en"
                                            v-model="form.title_en"
                                            placeholder="Enter English title"
                                        />
                                    </div>
                                </div>

                                <!-- Excerpts -->
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-2">
                                        <Label for="excerpt_id">Excerpt (Indonesian) *</Label>
                                        <Textarea
                                            id="excerpt_id"
                                            v-model="form.excerpt_id"
                                            placeholder="Enter Indonesian excerpt"
                                            rows="3"
                                            required
                                        />
                                    </div>
                                    <div class="space-y-2">
                                        <Label for="excerpt_en">Excerpt (English)</Label>
                                        <Textarea
                                            id="excerpt_en"
                                            v-model="form.excerpt_en"
                                            placeholder="Enter English excerpt"
                                            rows="3"
                                        />
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="space-y-2">
                                        <Label for="content_id">Content (Indonesian) *</Label>
                                        <RichTextEditor
                                            v-model="form.content_id"
                                            placeholder="Enter Indonesian content"
                                            :height="300"
                                        />
                                    </div>
                                    <div class="space-y-2">
                                        <Label for="content_en">Content (English)</Label>
                                        <RichTextEditor
                                            v-model="form.content_en"
                                            placeholder="Enter English content"
                                            :height="300"
                                        />
                                    </div>
                                </div>

                                <!-- Author -->
                                <div class="space-y-2">
                                    <Label for="author">Author *</Label>
                                    <Input
                                        id="author"
                                        v-model="form.author"
                                        placeholder="Enter author name"
                                        required
                                    />
                                </div>

                                <!-- Event-specific fields -->
                                <div v-if="isEvent" class="space-y-4 border-t pt-4">
                                    <h4 class="font-medium flex items-center gap-2">
                                        <Calendar class="h-4 w-4" />
                                        Event Details
                                    </h4>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <Label for="location_id">Location (Indonesian)</Label>
                                            <Input
                                                id="location_id"
                                                v-model="form.location_id"
                                                placeholder="Enter Indonesian location"
                                            />
                                        </div>
                                        <div class="space-y-2">
                                            <Label for="location_en">Location (English)</Label>
                                            <Input
                                                id="location_en"
                                                v-model="form.location_en"
                                                placeholder="Enter English location"
                                            />
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <Label for="start_date">Start Date</Label>
                                            <Input
                                                id="start_date"
                                                v-model="form.start_date"
                                                type="datetime-local"
                                            />
                                        </div>
                                        <div class="space-y-2">
                                            <Label for="end_date">End Date</Label>
                                            <Input
                                                id="end_date"
                                                v-model="form.end_date"
                                                type="datetime-local"
                                            />
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <Label for="organizer">Organizer</Label>
                                            <Input
                                                id="organizer"
                                                v-model="form.organizer"
                                                placeholder="Enter organizer name"
                                            />
                                        </div>
                                        <div class="space-y-2">
                                            <Label for="max_participants">Max Participants</Label>
                                            <Input
                                                id="max_participants"
                                                v-model="form.max_participants"
                                                type="number"
                                                min="1"
                                                placeholder="Enter max participants"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <!-- Status & Publishing -->
                                <div class="grid grid-cols-2 gap-4 border-t pt-4">
                                    <div class="space-y-2">
                                        <Label for="status">Status *</Label>
                                        <Select v-model="form.status" required>
                                            <option value="">
                                                <SelectValue placeholder="Select status" />
                                            
                                            
                                                <SelectItem v-for="(label, value) in statuses" :key="value" :value="value">
                                                    {{ label }}
                                                </SelectItem>
                                            </select>
                                        
                                    </div>
                                    <div class="flex items-center space-x-4 pt-6">
                                        <label class="flex items-center space-x-2">
                                            <input v-model="form.is_published" type="checkbox" />
                                            <span>Published</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input v-model="form.is_featured" type="checkbox" />
                                            <span>Featured</span>
                                        </label>
                                    </div>
                                </div>
                            </form>

                            <DialogFooter class="mt-6">
                                <Button type="button" variant="outline" @click="dialogOpen = false">
                                    Cancel
                                </Button>
                                <Button @click="handleSubmit" :disabled="form.loading">
                                    {{ form.loading ? 'Saving...' : (editingItem ? 'Update' : 'Create') }}
                                </Button>
                            </DialogFooter>
                        </DialogContent>
                    </Dialog>
                </div>

                <!-- Filters -->
                <Card>
                    <CardHeader>
                        <CardTitle class="flex items-center gap-2">
                            <FileText class="h-5 w-5" />
                            Filters
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            <div class="space-y-2">
                                <Label>Search</Label>
                                <Input 
                                    v-model="filters.search" 
                                    placeholder="Search by title, author, category..."
                                    @keyup.enter="applyFilters"
                                />
                            </div>
                            
                            <div class="space-y-2">
                                <Label>Type</Label>
                                <Select v-model="filters.type">
                                    <option value="">All Types</option>
                                    <option v-for="(label, value) in types" :key="value" :value="value">
                                        {{ label }}
                                    </option>
                                
                            </div>
                            
                            <div class="space-y-2">
                                <Label>Status</Label>
                                <Select v-model="filters.status">
                                    <option value="">All Statuses</option>
                                    <option v-for="(label, value) in statuses" :key="value" :value="value">
                                        {{ label }}
                                    </option>
                                
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <Button @click="applyFilters">Apply Filters</Button>
                            <Button variant="outline" @click="clearFilters">Clear Filters</Button>
                        </div>
                    </CardContent>
                </Card>

                <!-- Data Table -->
                <Card>
                    <CardHeader>
                        <CardTitle>Content List</CardTitle>
                        <CardDescription>
                            {{ newsEvents.meta?.total || 0 }} items total
                        </CardDescription>
                    </CardHeader>
                    <CardContent>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left p-4">Type</th>
                                        <th class="text-left p-4">Title</th>
                                        <th class="text-left p-4">Category</th>
                                        <th class="text-left p-4">Author</th>
                                        <th class="text-left p-4">Status</th>
                                        <th class="text-left p-4">Published</th>
                                        <th class="text-left p-4">Views</th>
                                        <th class="text-left p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in newsEvents.data" :key="item.id" class="border-b hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="p-4">
                                            <Badge :variant="getTypeBadgeVariant(item.type)">
                                                {{ types[item.type] }}
                                            </Badge>
                                        </td>
                                        <td class="p-4">
                                            <div class="flex items-center gap-2">
                                                <div>
                                                    <div class="font-medium">{{ item.title_id }}</div>
                                                    <div v-if="item.title_en" class="text-sm text-gray-500">{{ item.title_en }}</div>
                                                </div>
                                                <Star v-if="item.is_featured" class="h-4 w-4 text-yellow-500" />
                                            </div>
                                        </td>
                                        <td class="p-4">
                                            <Badge variant="outline">{{ item.category }}</Badge>
                                        </td>
                                        <td class="p-4">{{ item.author }}</td>
                                        <td class="p-4">
                                            <Badge :variant="getStatusBadgeVariant(item.status)">
                                                {{ statuses[item.status] }}
                                            </Badge>
                                        </td>
                                        <td class="p-4">
                                            <div class="flex items-center gap-2">
                                                <Eye v-if="item.is_published" class="h-4 w-4 text-green-500" />
                                                <EyeOff v-else class="h-4 w-4 text-gray-400" />
                                                <span class="text-sm">{{ item.published_at || '-' }}</span>
                                            </div>
                                        </td>
                                        <td class="p-4">{{ item.view_count }}</td>
                                        <td class="p-4">
                                            <div class="flex items-center gap-2">
                                                <Button @click="openEditDialog(item)" variant="outline" size="sm">
                                                    <Edit class="h-4 w-4" />
                                                </Button>
                                                <Button @click="confirmDelete(item.id)" variant="outline" size="sm">
                                                    <Trash2 class="h-4 w-4" />
                                                </Button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div v-if="newsEvents.data.length === 0" class="text-center py-8 text-muted-foreground">
                                No content found. Create your first content to get started.
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div v-if="newsEvents.links" class="flex justify-center mt-4">
                            <div class="flex gap-2">
                                <template v-for="(link, index) in newsEvents.links" :key="index">
                                    <Button
                                        v-if="link.url"
                                        :variant="link.active ? 'default' : 'outline'"
                                        size="sm"
                                        @click="router.visit(link.url)"
                                        v-html="link.label"
                                    />
                                    <span
                                        v-else
                                        class="px-3 py-1 text-sm text-muted-foreground"
                                        v-html="link.label"
                                    />
                                </template>
                            </div>
                        </div>
                    </CardContent>
                </Card>
            </div>
        </div>

        <!-- Confirm Delete Dialog -->
        <ConfirmDialog
            v-model:open="confirmDialog.open"
            title="Delete Content"
            description="Are you sure you want to delete this content? This action cannot be undone."
            :loading="confirmDialog.loading"
            @confirm="handleDelete"
        />
    </AppLayout>
</template>